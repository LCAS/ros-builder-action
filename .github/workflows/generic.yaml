name: reusable workflow

on:
  # make this workflow reusable (and only so)
  workflow_call:
    inputs:
      # target names
      ROS_DISTRO:
        type: string
        description: ROS distribution codename to compile for
        required: false # defaults to 'one'
      DEB_DISTRO:
        type: string
        description: The Debian/Ubuntu distribution codename to compile for.
        required: false  # defaults to 'lsb_release -cs'
      ROS_SOURCES:
        type: string
        description: ROS sources to compile. See README.md for details.
        required: false

      # workflow control
      PROCEED_FROM:
        type: string
        description: Where to start building from?
        required: true
      BUILD_TIMEOUT:
        type: number
        description: Cancel build after this time, before github will do (minutes)
        required: false

      # debian package repository options
      EXTRA_DEB_SOURCES:
        type: string
        description: extra debian sources to add to sources.list
        required: false
      INSTALL_GPG_KEYS:
        type: string
        description: code to run for installing GPG keys (for use with EXTRA_DEB_SOURCES)
        required: false
      EXTRA_ROSDEP_SOURCES:
        type: string
        description: path to a rosdep-compatible yaml file specifying custom dependency mappings
        required: false

      # build options
      EXTRA_SBUILD_CONFIG:
        type: string
        description: lines to add to ~/.sbuildrc
        required: false
      EXTRA_SBUILD_OPTS:
        type: string
        description: options to pass to sbuild on commandline
        required: false
      DEB_BUILD_OPTIONS:
        type: string
        description: options used debian/rules
        required: false
      CONTINUE_ON_ERROR:
        type: boolean
        description: Continue building even if some packages already failed
        required: false

      # deploy options
      DEBS_PATH:
        type: string
        description: path to store generated .debs in
        required: false

      REPO_PATH:
        type: string
        description: path to generate package repository in
        required: false

      DEPLOY_URL:
        type: string
        description: repository URL for deployment
        required: false
      BRANCH:
        type: string
        description: branch to use for deployment
        required: false

# Define environment variables from input, from configuration variables, or defaults - in this order!
# All inputs (declared above) are deliberately optional and don't provide an explicit default.
# Thus, if an input is not explicitly provided, we can fall back to the configuration variable here (var.* context).
# This variable context originates from the _calling_ workflow. Finally, a hard-coded default is given.
# https://docs.github.com/en/actions/learn-github-actions/variables#defining-configuration-variables-for-multiple-workflows
env:
  DEB_DISTRO: ${{ inputs.DEB_DISTRO || vars.DEB_DISTRO || 'jammy' }}
  ROS_DISTRO: ${{ inputs.ROS_DISTRO || vars.ROS_DISTRO || 'one' }}
  ROS_SOURCES: ${{ inputs.ROS_SOURCES || vars.ROS_SOURCES || '*.repos' }}

  EXTRA_DEB_SOURCES: ${{ inputs.EXTRA_DEB_SOURCES || vars.EXTRA_DEB_SOURCES }}
  INSTALL_GPG_KEYS: ${{ inputs.INSTALL_GPG_KEYS || vars.INSTALL_GPG_KEYS }}
  EXTRA_ROSDEP_SOURCES: ${{ inputs.EXTRA_ROSDEP_SOURCES || vars.EXTRA_ROSDEP_SOURCES }}

  DEBS_PATH: ${{ inputs.DEBS_PATH || vars.DEBS_PATH || '~/debs' }}
  REPO_PATH: ${{ inputs.REPO_PATH || vars.REPO_PATH || '~/repo' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  debs:
    runs-on: ubuntu-latest
    name: build debs

    env: # define common environment variables (cannot be passed from calling workflow)
      CCACHE_DIR: /home/runner/ccache
      SEGMENT_DOWNLOAD_TIMEOUT_MINS: 10
      DEBUG_BASH: ${{ secrets.ACTIONS_STEP_DEBUG && 'true' || 'false' }}

    steps:
      - uses: actions/checkout@v3

      - name: Download debs from previous run
        uses: actions/download-artifact@v3
        if: ${{ inputs.PROCEED_FROM == 'from previous run' }}
        with:
          name: debs
          path: ${{ env.DEBS_PATH }}

      - name: Restore ccache
        id: restore-ccache
        uses: actions/cache/restore@v3
        env:
          CACHE_ID: "ccache-${{ inputs.DEB_DISTRO || vars.DEB_DISTRO }}\
                           -${{ inputs.ROS_DISTRO || vars.ROS_DISTRO }}\
                           -${{ hashFiles(inputs.ROS_SOURCES || vars.ROS_SOURCES) || inputs.ROS_SOURCES || vars.ROS_SOURCES }}"
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ env.CACHE_ID }}-${{ github.run_id }}
          restore-keys: |
            ${{ env.CACHE_ID }}

      - name: Build .deb packages
        uses: ubi-agni/ros-builder-action@main
        # leave some time for the remaining steps too (github cancels the job after 360 minutes)
        timeout-minutes: ${{ inputs.BUILD_TIMEOUT || vars.BUILD_TIMEOUT || 340 }}
        env:
          EXTRA_SBUILD_CONFIG: ${{ inputs.EXTRA_SBUILD_CONFIG || vars.EXTRA_SBUILD_CONFIG }}
          EXTRA_SBUILD_OPTS: ${{ inputs.EXTRA_SBUILD_OPTS || vars.EXTRA_SBUILD_OPTS }}
          DEB_BUILD_OPTIONS: ${{ inputs.DEB_BUILD_OPTIONS || vars.DEB_BUILD_OPTIONS || 'nocheck' }}
          CONTINUE_ON_ERROR: ${{ inputs.CONTINUE_ON_ERROR || vars.CONTINUE_ON_ERROR || false }}
          PROCEED_FROM: ${{ inputs.PROCEED_FROM }}

      - name: Store ccache
        uses: actions/cache/save@v3
        if: always() # save cache on timeout or cancel too
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ steps.restore-ccache.outputs.cache-primary-key }}

      - name: Upload debs
        uses: actions/upload-artifact@v3
        if: always() # upload on timeout or cancel too
        with:
          name: debs
          path: ${{ env.DEBS_PATH }}
          if-no-files-found: error

  repo:
    needs: debs
    runs-on: ubuntu-latest
    name: create repo
    if: (inputs.DEPLOY_URL || vars.DEPLOY_URL) && (inputs.DEPLOY_URL != 'skip')

    env: # define common environment variables (cannot be passed from calling workflow)
      SEGMENT_DOWNLOAD_TIMEOUT_MINS: 10
      DEBUG_BASH: ${{ secrets.ACTIONS_STEP_DEBUG && 'true' || 'false' }}
      DEPLOY_URL:: ${{ inputs.DEPLOY_URL || vars.DEPLOY_URL }}
      BRANCH: "${{ inputs.BRANCH || \
        format('{0}-{1}', inputs.DEB_DISTRO || vars.DEB_DISTRO || 'jammy', \
                          inputs.ROS_DISTRO || vars.ROS_DISTRO || 'one') }}"

    steps:
      - name: Download debs from build
        uses: actions/download-artifact@v3
        with:
          name: debs
          path: ${{ env.DEBS_PATH }}

      - name: Run flat-repo action
        uses: ubi-agni/ros-builder-action/flat-repo@main

      - name: Upload repo
        uses: actions/upload-artifact@v3
        if: always() # upload on timeout or cancel too
        with:
          name: repo
          path: ${{ env.REPO_PATH }}
          if-no-files-found: error
